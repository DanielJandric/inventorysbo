<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Marchés - BONVIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root {
            --bg-color: #0A232A;
            --glass-bg: rgba(10, 50, 60, 0.25);
            --glass-border: rgba(0, 200, 220, 0.2);
            --glass-glow: rgba(0, 220, 255, 0.15);
            --text-primary: #e0e6e7;
            --text-secondary: #88a0a8;
        }
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        body::before {
            content: '';
            position: fixed; inset: 0;
            background: radial-gradient(circle at 15% 25%, rgba(0, 220, 255, 0.2), transparent 40%),
                        radial-gradient(circle at 85% 75%, rgba(10, 50, 60, 0.3), transparent 40%);
            z-index: -1; filter: blur(50px);
            animation: moveGradient 20s linear infinite alternate;
        }
        @keyframes moveGradient { from { transform: translate(0,0); } to { transform: translate(5vw,-5vh); } }
        .glass { background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 1.5rem; }
        .glass-dark { background: rgba(10, 40, 50, 0.4); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 1.5rem; }
        .glowing-element { position: relative; transition: all .3s ease; }
        .glowing-element::before { content:''; position:absolute; inset:0; border-radius:inherit; background: radial-gradient(circle at 50% 50%, var(--glass-glow), transparent 70%); filter: blur(30px); opacity:.6; z-index:-1; transition: opacity .3s ease; }
        .glowing-element:hover::before, .glowing-element.is-active::before { opacity: 1; }
    </style>
</head>
<body class="h-full">
    <div class="min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-10 pt-6">
            <div class="flex justify-center mb-4">
                <img src="/static/1da6a1fb-f4c3-401c-aa60-63e9b63360b0.png" alt="BONVIN Logo" class="w-40 h-auto md:w-48">
            </div>
            <h1 class="text-3xl md:text-4xl font-bold tracking-wider">Update Marchés</h1>
            <p class="text-sm text-cyan-200/70 mt-2">Analyse automatisée et dépôt de PDFs</p>
        </header>

        <!-- Hamburger Menu -->
        <div class="fixed top-6 right-6 z-50">
            <button id="hamburger-menu" class="glass glowing-element p-3 rounded-xl transition-all duration-300 hover:scale-105" onclick="toggleHamburgerMenu()">
                <svg class="w-6 h-6 text-cyan-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <div id="hamburger-dropdown" class="glass-dark glowing-element absolute top-full right-0 mt-3 rounded-2xl p-4 min-w-64 transform scale-95 opacity-0 pointer-events-none transition-all duration-300 origin-top-right">
                <div class="space-y-2">
                    <a href="/" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span>Collection</span>
                    </a>
                    <a href="/analytics" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        <span>Analytics</span>
                    </a>
                    <a href="/sold" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        <span>Vendu</span>
                    </a>
                    <a href="/markets" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-white bg-opacity-10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span>Update Marchés</span>
                    </a>
                    <a href="/settings" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white hover:bg-opacity-10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
        </div>

        <main class="max-w-7xl mx-auto space-y-8">
            <!-- Section Analyse Automatisée -->
            <section class="glass p-6 rounded-2xl">
                <div class="flex items-center justify-between gap-4 flex-wrap">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-cyan-500/10 border border-cyan-400/30 text-cyan-300">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h2 class="text-xl font-semibold">Analyse Automatisée</h2>
                    </div>
                    <button id="start-analysis-btn" class="glowing-element px-5 py-3 rounded-xl bg-cyan-500/20 border border-cyan-400/30 hover:bg-cyan-500/30 text-cyan-100 font-semibold transition hidden" aria-hidden="true">
                        <i class="fas fa-play-circle mr-2"></i> Lancer une Nouvelle Analyse
                    </button>
                </div>
                <div id="status-display" class="mt-4 rounded-xl p-4 text-center bg-white/5 border border-white/10">
                    <span id="status-icon"><i class="fas fa-info-circle"></i></span>
                    <span id="status-text" class="ml-2">Prêt à lancer une nouvelle analyse.</span>
                </div>
                <div id="analysis-result" class="hidden mt-4"></div>
            </section>

            <!-- Chatbot Marchés -->
            <section class="glass p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-cyan-500/10 border border-cyan-400/30 text-cyan-300">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h2 class="text-xl font-semibold">Chatbot Marchés</h2>
                </div>
                <div id="chatbox" class="space-y-3">
                    <div id="chat-messages" class="bg-white/5 border border-white/10 rounded-xl p-4 h-64 overflow-y-auto overflow-x-hidden text-sm space-y-2 columns-1"></div>
                    <div class="flex gap-2">
                        <input id="chat-input" class="flex-1 px-3 py-2 rounded-lg bg-white/5 border border-white/10" placeholder="Posez votre question (ex: patterns, risques, scénarios)..."/>
                        <button id="chat-send" class="px-4 py-2 rounded-lg bg-cyan-500/20 border border-cyan-400/30 hover:bg-cyan-500/30">Envoyer</button>
                    </div>
                    <textarea id="chat-context" class="mt-2 w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-xs" rows="3" placeholder="Optionnel: Collez ici un extrait de rapport ou un contexte métier pour guider l'analyse (utilisé en plus des 10-15 derniers rapports)."></textarea>
                    <div class="flex justify-end">
                        <button id="chat-export" class="mt-2 px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-xs"><i class="fas fa-file-pdf mr-1"></i> Exporter en PDF</button>
                    </div>
                </div>
            </section>

            <!-- Derniers rapports -->
            <section class="glass p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-cyan-500/10 border border-cyan-400/30 text-cyan-300">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h2 class="text-xl font-semibold">15 Derniers Rapports</h2>
                </div>
                <div id="recent-analyses" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-cyan-200/70">Chargement…</div>
                </div>
            </section>

            <!-- Section Rapports PDF -->
            <section class="glass p-6 rounded-2xl">
                 <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                    <div class="flex items-center gap-3">
                         <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/10 border border-red-400/30 text-red-300">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h2 class="text-xl font-semibold">Rapports PDF Disponibles</h2>
                    </div>
                    <button id="refresh-pdfs" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm">Actualiser</button>
                </div>
                <!-- Galerie de PDFs -->
                <div id="market-pdf-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-cyan-200/70">Chargement des rapports...</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Hamburger Menu ---
        function toggleHamburgerMenu() {
            const dropdown = document.getElementById('hamburger-dropdown');
            dropdown.classList.toggle('pointer-events-none');
            dropdown.classList.toggle('opacity-0');
            dropdown.classList.toggle('scale-95');
        }
        document.addEventListener('click', (e) => {
            const btn = document.getElementById('hamburger-menu');
            const dd = document.getElementById('hamburger-dropdown');
            if (!btn.contains(e.target) && !dd.contains(e.target)) {
                dd.classList.add('pointer-events-none', 'opacity-0', 'scale-95');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('start-analysis-btn');
            const statusDisplay = document.getElementById('status-display');
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            const resultDiv = document.getElementById('analysis-result');
            let pollingInterval;
            const recentContainerId = 'recent-analyses';

            // --- Analyse Automatisée ---
            function updateUI(state, data = null) {
                switch (state) {
                    case 'idle':
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Lancer une Nouvelle Analyse';
                        statusDisplay.className = 'mt-4 rounded-xl p-4 text-center bg-white/5 border border-white/10';
                        statusIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
                        statusText.textContent = 'Prêt à lancer une nouvelle analyse.';
                        resultDiv.classList.add('hidden');
                        break;
                    case 'pending':
                    case 'processing':
                        startBtn.disabled = true;
                        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analyse en cours...';
                        statusDisplay.className = 'mt-4 rounded-xl p-4 text-center bg-cyan-500/10 border border-cyan-400/30';
                        statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        statusText.textContent = 'Analyse en cours... Veuillez patienter.';
                        resultDiv.classList.add('hidden');
                        break;
                    case 'completed':
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Lancer une Nouvelle Analyse';
                        statusDisplay.className = 'mt-4 rounded-xl p-4 text-center bg-green-500/10 border border-green-400/30';
                        statusIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                        statusText.textContent = `Analyse terminée le ${new Date(data.timestamp).toLocaleString('fr-FR')}.`;
                        renderAnalysis(data);
                        // Rafraîchir la liste des 15 derniers rapports (sans await pour éviter une erreur de syntaxe)
                        try { loadRecentAnalyses(); } catch (e) {}
                        break;
                    case 'error':
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i> Lancer une Nouvelle Analyse';
                        statusDisplay.className = 'mt-4 rounded-xl p-4 text-center bg-red-500/10 border border-red-400/30';
                        statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        statusText.textContent = `Erreur lors de l'analyse : ${data.error_message}`;
                        resultDiv.classList.add('hidden');
                        break;
                }
            }

            function renderAnalysis(analysis) {
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <h3 class="text-xl font-semibold mb-4">Résultats de l'Analyse</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Executive Summary -->
                        ${analysis.executive_summary ? `
                        <div class="glass p-4 rounded-xl lg:col-span-2 bg-gradient-to-r from-cyan-900/20 to-blue-900/20 border border-cyan-400/30">
                            <h5 class="font-bold mb-3 text-cyan-200"><i class="fas fa-chart-bar mr-2"></i>EXECUTIVE SUMMARY</h5>
                            <div class="space-y-2 text-cyan-100 font-medium">
                                ${(analysis.executive_summary || []).map(point => `<div class="pl-2">${point}</div>`).join('')}
                            </div>
                        </div>
                        ` : ''}
                        <!-- Analyse IA (cartes colorées sobres) -->
                        <div class="glass p-4 rounded-xl bg-indigo-500/10 border border-indigo-400/30"><h6 class="font-medium mb-2"><i class="fas fa-chart-line mr-2"></i>Résumé</h6><p class="text-indigo-100/80 text-sm">${analysis.summary || 'N/A'}</p></div>
                        <div class="glass p-4 rounded-xl bg-fuchsia-500/10 border border-fuchsia-400/30"><h6 class="font-medium mb-2"><i class="fas fa-list mr-2"></i>Points Clés</h6><ul class="list-disc list-inside text-fuchsia-100/90 text-sm">${(analysis.key_points || []).map(p => `<li>${p}</li>`).join('')}</ul></div>
                        <div class="glass p-4 rounded-xl bg-amber-500/10 border border-amber-400/30"><h6 class="font-medium mb-2"><i class="fas fa-lightbulb mr-2"></i>Insights</h6><ul class="list-disc list-inside text-amber-100/90 text-sm">${(analysis.insights || []).map(p => `<li>${p}</li>`).join('')}</ul></div>
                        <div class="glass p-4 rounded-xl bg-rose-500/10 border border-rose-400/30"><h6 class="font-medium mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Risques</h6><ul class="list-disc list-inside text-rose-100/90 text-sm">${(analysis.risks || []).map(p => `<li>${p}</li>`).join('')}</ul></div>
                        <div class="glass p-4 rounded-xl lg:col-span-2 bg-emerald-500/10 border border-emerald-400/30"><h6 class="font-medium mb-2"><i class="fas fa-star mr-2"></i>Opportunités</h6><ul class="list-disc list-inside text-emerald-100/90 text-sm">${(analysis.opportunities || []).map(p => `<li>${p}</li>`).join('')}</ul></div>
                        
                    </div>`;
            }

            // Liste des 15 derniers rapports
            async function loadRecentAnalyses() {
                try {
                    const resp = await fetch('/api/market-analyses/recent');
                    const data = await resp.json();
                    const container = document.getElementById(recentContainerId);
                    if (!container) return;
                    if (!data.success) {
                        container.innerHTML = '<p class="text-red-400">Erreur de chargement</p>';
                        return;
                    }
                    if (!data.items || data.items.length === 0) {
                        container.innerHTML = '<p class="text-cyan-200/70">Aucun rapport pour le moment.</p>';
                        return;
                    }
                    container.innerHTML = data.items.map((a) => {
                        const id = a.id;
                        // Rendu enrichi: on autorise quelques marqueurs Markdown légers (**gras**) -> <strong>
                        let htmlSummary = (a.summary || '')
                          .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
                          .replace(/\n/g, '<br/>' )
                          .replace(/↑/g, '<span class="text-green-400">↑<\/span>')
                          .replace(/↓/g, '<span class="text-red-400">↓<\/span>')
                          .replace(/🟢/g, '<span class="text-green-400">🟢<\/span>')
                          .replace(/🔴/g, '<span class="text-red-400">🔴<\/span>');
                        const execHtml = (a.executive_summary || []).map(p => `<li>${p}</li>`).join('');
                        const fullHtml = `
                          <article class="glass p-4 rounded-2xl">
                            <header class="flex items-center justify-between gap-3">
                              <div>
                                <h6 class="font-semibold">${a.analysis_type || 'auto'} • ${new Date(a.timestamp || a.created_at).toLocaleString('fr-FR')}</h6>
                                <span class="text-xs text-cyan-200/60">${a.worker_status}</span>
                              </div>
                              <button data-id="${id}" class="delete-btn px-3 py-1.5 rounded-lg bg-red-500/20 border border-red-500/40 text-red-200 text-xs hover:bg-red-500/30">Supprimer</button>
                            </header>
                            ${a.executive_summary ? `<div class='mt-3'><h6 class='font-semibold mb-1'>Executive Summary</h6><ul class='text-sm text-cyan-100/90 list-disc list-inside'>${execHtml}</ul></div>` : ''}
                            ${htmlSummary ? `<div class='mt-3 text-sm leading-6'>${htmlSummary}</div>` : ''}
                          </article>`;
                        return fullHtml;
                    }).join('');

                    // Bind suppression
                    container.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            if (!id) return;
                            if (!confirm('Confirmer la suppression de ce rapport ?')) return;
                            try {
                                const r = await fetch(`/api/market-analyses/${id}`, { method: 'DELETE' });
                                const d = await r.json();
                                if (!d.success) throw new Error(d.error || 'Suppression échouée');
                                loadRecentAnalyses();
                            } catch (err) {
                                alert('Erreur: ' + err.message);
                            }
                        });
                    });
                } catch (e) {
                    const container = document.getElementById(recentContainerId);
                    if (container) container.innerHTML = `<p class='text-red-400'>${e.message}</p>`;
                }
            }
            
            async function checkStatus() {
                try {
                    const response = await fetch('/api/background-worker/status');
                    if (!response.ok) throw new Error('Erreur réseau');
                    const data = await response.json();
                    if (['processing', 'pending'].includes(data.status)) {
                        updateUI(data.status);
                        if (!pollingInterval) pollingInterval = setInterval(checkStatus, 5000);
                    } else {
                        if (pollingInterval) clearInterval(pollingInterval);
                        pollingInterval = null;
                        updateUI(data.status, data.analysis || data);
                    }
                } catch (error) {
                    if (pollingInterval) clearInterval(pollingInterval);
                    pollingInterval = null;
                    updateUI('error', { error_message: error.message });
                }
            }

            startBtn.addEventListener('click', async () => {
                updateUI('pending');
                try {
                    const response = await fetch('/api/background-worker/trigger', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        if (!pollingInterval) pollingInterval = setInterval(checkStatus, 5000);
                    } else {
                        updateUI('error', { error_message: data.error });
                    }
                } catch (error) {
                    updateUI('error', { error_message: error.message });
                }
            });
            checkStatus();

            // --- PDFs Manuels ---
            async function loadMarketPdfs() {
                const container = document.getElementById('market-pdf-gallery');
                try {
                    container.innerHTML = '<p class="text-cyan-200/70 col-span-full text-center">Chargement des rapports...</p>';
                    const resp = await fetch('/api/market-pdfs');
                    const data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error(data.error || 'Erreur de chargement');
                    
                    if (!data.files || data.files.length === 0) {
                        container.innerHTML = '<p class="text-cyan-200/70 col-span-full text-center">Aucun rapport PDF déposé pour le moment. Allez dans les <a href="/settings" class="font-semibold text-cyan-300 hover:underline">Settings</a> pour en déposer.</p>';
                        return;
                    }

                    // Trier les fichiers par date de modification, du plus récent au plus ancien
                    data.files.sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at));

                    container.innerHTML = data.files.map(f => `
                        <article class="glass p-4 rounded-2xl flex flex-col gap-3 transition-all hover:ring-2 ring-cyan-400/50">
                            <header class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/10 border border-red-400/30 text-red-300 shrink-0">
                                    <i class="fas fa-file-pdf"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <h4 class="font-semibold text-cyan-100 truncate" title="${f.name}">${f.name}</h4>
                                    <p class="text-cyan-200/60 text-xs">${new Date(f.modified_at).toLocaleString('fr-FR')}</p>
                                </div>
                            </header>
                             <div class="rounded-xl overflow-hidden border border-white/10 bg-black/30 aspect-video mt-2">
                               <iframe src="${f.url}#toolbar=0&navpanes=0&scrollbar=0" class="w-full h-full border-0"></iframe>
                            </div>
                            <footer class="flex gap-2 justify-end mt-2">
                                <a href="${f.url}" target="_blank" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm transition-colors">Ouvrir</a>
                                <a href="${f.url}" download class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm transition-colors">Télécharger</a>
                            </footer>
                        </article>
                    `).join('');
                } catch (e) {
                    container.innerHTML = `<p class="text-red-400 col-span-full text-center">❌ Erreur lors du chargement des PDFs: ${e.message}</p>`;
                }
            }

            document.getElementById('refresh-pdfs').addEventListener('click', loadMarketPdfs);
            loadMarketPdfs();
            loadRecentAnalyses();

            // Chat events
            const messagesDiv = document.getElementById('chat-messages');
            const inputEl = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send');
            const exportBtn = document.getElementById('chat-export');
            function addMsg(role, text) {
                const html = (text || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br/>');
                const wrapper = document.createElement('div');
                wrapper.className = role === 'user' ? 'w-full flex justify-end' : 'w-full flex justify-start';
                const bubble = document.createElement('div');
                bubble.className = role === 'user'
                  ? 'max-w-[80%] rounded-2xl px-4 py-3 bg-cyan-500/20 border border-cyan-400/30 text-cyan-100 shadow break-words whitespace-pre-wrap leading-6 overflow-hidden columns-1 [column-count:1]'
                  : 'max-w-[80%] rounded-2xl px-4 py-3 bg-white/5 border border-white/10 text-cyan-100/90 shadow break-words whitespace-pre-wrap leading-6 overflow-hidden columns-1 [column-count:1]';
                bubble.innerHTML = html;
                wrapper.appendChild(bubble);
                messagesDiv.appendChild(wrapper);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function createTypingBubble() {
                const wrapper = document.createElement('div');
                wrapper.className = 'w-full flex justify-start';
                const bubble = document.createElement('div');
                bubble.className = 'max-w-[80%] rounded-2xl px-4 py-3 bg-white/5 border border-white/10 text-cyan-100/90 shadow flex items-center gap-1';
                const d1 = document.createElement('span'); d1.className = 'w-2 h-2 bg-cyan-300 rounded-full animate-bounce';
                const d2 = document.createElement('span'); d2.className = 'w-2 h-2 bg-cyan-300 rounded-full animate-bounce'; d2.style.animationDelay = '0.15s';
                const d3 = document.createElement('span'); d3.className = 'w-2 h-2 bg-cyan-300 rounded-full animate-bounce'; d3.style.animationDelay = '0.3s';
                bubble.appendChild(d1); bubble.appendChild(d2); bubble.appendChild(d3);
                wrapper.appendChild(bubble);
                return { wrapper, bubble };
            }
            async function sendChat() {
                const msg = (inputEl.value || '').trim();
                if (!msg) return;
                addMsg('user', msg);
                inputEl.value = '';
                try {
                    const extra = (document.getElementById('chat-context').value || '').trim();
                    // session_id persistée
                    let sid = localStorage.getItem('markets_chat_session_id');
                    if (!sid) {
                        sid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(36).slice(2));
                        localStorage.setItem('markets_chat_session_id', sid);
                    }
                    let prevId = localStorage.getItem('markets_prev_response_id') || '';
                    if (!(prevId && prevId.startsWith('resp'))) {
                        prevId = '';
                    }
                    

                    const reqBody = { message: msg, context: extra, session_id: sid, previous_response_id: prevId };
                    // Réactiver streaming avec watchdog + fallback sync
                    const controller = new AbortController();
                    const signal = controller.signal;
                    let resp = await fetch('/api/markets/chat/stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reqBody),
                        signal
                    });
                    if (!resp.ok || !resp.body) {
                        const rSync = await fetch('/api/markets/chat', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reqBody)
                        });
                        const dSync = await rSync.json();
                        if (!dSync.success) throw new Error(dSync.error || 'Erreur API');
                        addMsg('assistant', dSync.reply);
                        return;
                    }

                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();
                    let buf = '';
                    let responseId = null;

                    // Prépare une bulle d'output + indicateur de frappe
                    const typing = createTypingBubble();
                    messagesDiv.appendChild(typing.wrapper);

                    let hadData = false;
                    // Timeouts plus tolérants (évite abort prématuré)
                    const firstChunkTimeoutMs = 45000;
                    const hardTimeoutMs = 180000;
                    let timedOut = false;
                    const firstChunkTimer = setTimeout(() => { try { controller.abort(); } catch {} }, firstChunkTimeoutMs);
                    const hardTimer = setTimeout(() => { timedOut = true; try { controller.abort(); } catch {} }, hardTimeoutMs);
                    // Throttle DOM updates to avoid flicker
                    let scheduled = false;
                    const flush = () => {
                        streamingEl.innerHTML = '<strong>Assistant:</strong> ' + buf
                          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                          .replace(/\n/g, '<br/>' );
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        scheduled = false;
                    };

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const raw = decoder.decode(value, { stream: true });
                        if (!raw) continue;
                        hadData = true;
                        clearTimeout(firstChunkTimer);

                        const events = raw.split('\n\n').filter(Boolean);
                        for (const ev of events) {
                            if (ev.startsWith(':')) continue; // heartbeat
                            if (!ev.startsWith('data:')) continue;
                            const jsonStr = ev.replace(/^data:\s*/, '');
                            try {
                                const obj = JSON.parse(jsonStr);
                                if (obj.error) {
                                    // Fallback sync immédiat sur erreur
                                    try {
                                        const rf = await fetch('/api/markets/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reqBody) });
                                        const df = await rf.json();
                                        if (df && df.success) {
                                            typing.wrapper.remove();
                                            addMsg('assistant', df.reply);
                                            clearTimeout(firstChunkTimer); clearTimeout(hardTimer);
                                            return;
                                        }
                                    } catch {}
                                    typing.bubble.innerHTML = `❌ ${obj.error}`;
                                    continue;
                                }
                                if (obj.delta) {
                                    buf += String(obj.delta);
                                    // Afficher/mettre à jour la bulle de réponse (remplacer typing)
                                    if (!typing.wrapper.dataset.upgraded) {
                                        typing.bubble.innerHTML = '';
                                        typing.wrapper.dataset.upgraded = '1';
                                    }
                                    if (!scheduled) {
                                        scheduled = true;
                                        setTimeout(() => {
                                            typing.bubble.innerHTML = buf
                                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                                .replace(/\n/g, '<br/>' );
                                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                            scheduled = false;
                                        }, 60);
                                    }
                                }
                                if (obj.done) {
                                    if (obj.id && String(obj.id).startsWith('resp')) {
                                        localStorage.setItem('markets_prev_response_id', obj.id);
                                    }
                                    clearTimeout(firstChunkTimer); clearTimeout(hardTimer);
                                    typing.bubble.innerHTML = buf
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/\n/g, '<br/>' );
                                    break;
                                }
                            } catch {
                                // ignore malformed chunk
                            }
                        }
                    }
                    clearTimeout(firstChunkTimer); clearTimeout(hardTimer);
                    // Si pas de data utile reçue (proxy a coupé) ou timeout, fallback sync une fois
                    if (!hadData || timedOut) {
                        const r2 = await fetch('/api/markets/chat', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reqBody)
                        });
                        const d2 = await r2.json();
                        if (!d2.success) throw new Error(d2.error || 'Erreur API');
                        streamingEl.remove();
                        addMsg('assistant', d2.reply);
                        return;
                    }
                } catch (e) {
                    try {
                        const reqBody = {
                            message: (document.getElementById('chat-input').value || msg || '').trim() || msg,
                            context: (document.getElementById('chat-context').value || '').trim(),
                            session_id: localStorage.getItem('markets_chat_session_id') || '',
                            previous_response_id: localStorage.getItem('markets_prev_response_id') || ''
                        };
                        const r2 = await fetch('/api/markets/chat', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(reqBody)
                        });
                        const d2 = await r2.json();
                        if (d2 && d2.success) { addMsg('assistant', d2.reply); return; }
                    } catch {}
                    addMsg('assistant', `❌ ${e && e.message ? e.message : 'Erreur réseau'}`);
                }
            }
            sendBtn.addEventListener('click', sendChat);
            inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendChat(); });

            // Export PDF de la dernière discussion
            exportBtn.addEventListener('click', async () => {
                try {
                    const nodes = Array.from(messagesDiv.querySelectorAll('div'));
                    const payload = nodes.map((el) => {
                        const t = el.textContent || '';
                        const role = t.startsWith('Vous:') ? 'user' : 'assistant';
                        return { role, text: t.replace(/^Vous:\s*/, '').replace(/^Assistant:\s*/, '') };
                    });
                    const r = await fetch('/api/markets/chat/export-pdf', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: payload }) });
                    if (!r.ok) throw new Error('Export serveur échoué');
                    const blob = await r.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'chat_update_marches.pdf';
                    document.body.appendChild(a); a.click();
                    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
                } catch (e) {
                    alert('Erreur export PDF: ' + e.message);
                }
            });
        });
    </script>
</body>
</html>
