<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marchés Financiers - InventorySBO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .card {
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .loading {
            display: none;
        }
        .result-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
        }
        .ai-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .scrapingbee-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/">
                                <i class="fas fa-home"></i> Accueil
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/analytics">
                                <i class="fas fa-chart-bar"></i> Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/reports">
                                <i class="fas fa-file-alt"></i> Rapports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/markets">
                                <i class="fas fa-chart-line"></i> Marchés
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/settings">
                                <i class="fas fa-cog"></i> Paramètres
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/sold">
                                <i class="fas fa-tags"></i> Vendu
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-chart-line"></i> Marchés Financiers
                    </h1>
                </div>

                <!-- ScrapingBee Section -->
                <div class="scrapingbee-section">
                    <h3><i class="fas fa-robot"></i> Analyse Exhaustive des Marchés - ScrapingBee</h3>
                    <p>Génère une analyse complète et exhaustive des marchés financiers avec focus sur l'IA</p>
                    
                                         <div class="row">
                         <div class="col-md-4">
                             <button id="generateMarketUpdate" class="btn btn-light btn-lg w-100">
                                 <i class="fas fa-sync-alt"></i> Récupérer Analyse
                             </button>
                         </div>
                         <div class="col-md-4">
                             <button id="triggerBackgroundWorker" class="btn btn-warning btn-lg w-100">
                                 <i class="fas fa-cog"></i> Déclencher Worker
                             </button>
                         </div>
                         <div class="col-md-4">
                             <div class="d-flex align-items-center">
                                 <span class="status-indicator status-online" id="scrapingbeeStatus"></span>
                                 <span id="scrapingbeeStatusText">Background Worker: En ligne</span>
                             </div>
                         </div>
                     </div>
                    
                    <div class="loading mt-3" id="scrapingbeeLoading">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Analyse en cours...</span>
                        </div>
                    </div>
                    
                    <div id="scrapingbeeResult" class="result-box" style="display: none;">
                        <h5><i class="fas fa-chart-pie"></i> Résultat de l'Analyse</h5>
                        <div id="scrapingbeeContent"></div>
                    </div>
                </div>

                <!-- AI Analysis Section -->
                <div class="ai-analysis">
                    <h3><i class="fas fa-brain"></i> Analyse IA des Marchés</h3>
                    <p>Analyse intelligente des tendances et opportunités</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button id="generateAIAnalysis" class="btn btn-light btn-lg w-100">
                                <i class="fas fa-magic"></i> Générer Analyse IA
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator status-online" id="aiStatus"></span>
                                <span id="aiStatusText">IA: En ligne</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loading mt-3" id="aiLoading">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Analyse IA en cours...</span>
                        </div>
                    </div>
                    
                    <div id="aiResult" class="result-box" style="display: none;">
                        <h5><i class="fas fa-robot"></i> Analyse IA</h5>
                        <div id="aiContent"></div>
                    </div>
                </div>

                <!-- Market Updates Section -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-clock"></i> Dernières Mises à Jour</h5>
                            </div>
                            <div class="card-body">
                                <div id="marketUpdates">
                                    <p class="text-muted">Chargement des mises à jour...</p>
                                </div>
                                <button id="refreshUpdates" class="btn btn-primary btn-sm">
                                    <i class="fas fa-sync-alt"></i> Actualiser
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-area"></i> Statut des Services</h5>
                            </div>
                            <div class="card-body">
                                <div id="serviceStatus">
                                    <p class="text-muted">Vérification des services...</p>
                                </div>
                                <button id="checkServices" class="btn btn-info btn-sm">
                                    <i class="fas fa-check-circle"></i> Vérifier
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Market Data Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-database"></i> Données de Marché</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>S&P 500</h6>
                                            <span id="sp500" class="h4">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>NASDAQ</h6>
                                            <span id="nasdaq" class="h4">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Dow Jones</h6>
                                            <span id="dow" class="h4">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Bitcoin</h6>
                                            <span id="bitcoin" class="h4">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Attendre que le DOM soit chargé
        document.addEventListener('DOMContentLoaded', function() {
            // ScrapingBee Market Update
            document.getElementById('generateMarketUpdate').addEventListener('click', async function() {
            const loading = document.getElementById('scrapingbeeLoading');
            const result = document.getElementById('scrapingbeeResult');
            const content = document.getElementById('scrapingbeeContent');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            
            try {
                // Utiliser le Background Worker pour éviter les timeouts
                const response = await fetch('/api/scrapingbee/market-update/quick', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const analysis = data.data;
                    content.innerHTML = `
                        <div class="mb-3">
                            <h6><i class="fas fa-chart-line"></i> Résumé Exécutif</h6>
                            <p class="text-justify">${analysis.summary || 'Aucun résumé disponible'}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-list"></i> Points Clés (${(analysis.key_points || []).length})</h6>
                            <ul>
                                ${(analysis.key_points || []).map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-chart-bar"></i> Données Structurées</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Prix:</strong> ${analysis.structured_data?.prix || 'N/A'}<br>
                                    <strong>Tendance:</strong> ${analysis.structured_data?.tendance || 'N/A'}<br>
                                    <strong>Volumes:</strong> ${analysis.structured_data?.volumes || 'N/A'}
                                </div>
                                <div class="col-md-6">
                                    <strong>Actualités:</strong><br>
                                    <ul>
                                        ${(analysis.structured_data?.actualités || []).map(act => `<li>${act}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-lightbulb"></i> Insights (${(analysis.insights || []).length})</h6>
                            <ul>
                                ${(analysis.insights || []).map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-exclamation-triangle"></i> Risques (${(analysis.risks || []).length})</h6>
                            <ul>
                                ${(analysis.risks || []).map(risk => `<li>${risk}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-star"></i> Opportunités (${(analysis.opportunities || []).length})</h6>
                            <ul>
                                ${(analysis.opportunities || []).map(opp => `<li>${opp}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-link"></i> Sources (${analysis.sources?.length || 0})</h6>
                            <ul>
                                ${(analysis.sources || []).map(source => `<li><a href="${source.url}" target="_blank">${source.title}</a></li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="fas fa-chart-pie"></i> Score de Confiance</h6>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${(analysis.confidence_score || 0) * 100}%">
                                    ${Math.round((analysis.confidence_score || 0) * 100)}%
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-muted">
                            <small>Analyse générée le ${new Date().toLocaleString('fr-FR')}</small>
                        </div>
                    `;
                    result.style.display = 'block';
                } else {
                    content.innerHTML = `<div class="alert alert-danger">Erreur: ${data.error}</div>`;
                    result.style.display = 'block';
                }
            } catch (error) {
                content.innerHTML = `<div class="alert alert-danger">Erreur: ${error.message}</div>`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        });

        // Background Worker Trigger
        document.getElementById('triggerBackgroundWorker').addEventListener('click', async function() {
            const button = this;
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Déclenchement...';
            
            try {
                const response = await fetch('/api/background-worker/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Background Worker déclenché avec succès ! L\'analyse sera disponible dans quelques minutes.');
                } else {
                    alert('❌ Erreur: ' + data.error);
                }
            } catch (error) {
                alert('❌ Erreur: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        });

        // AI Analysis
        document.getElementById('generateAIAnalysis').addEventListener('click', async function() {
            const loading = document.getElementById('aiLoading');
            const result = document.getElementById('aiResult');
            const content = document.getElementById('aiContent');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            
            try {
                const response = await fetch('/api/unified/market-briefing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: "Analyse IA des marchés financiers avec focus sur les opportunités et risques"
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    content.innerHTML = `
                        <div class="mb-3">
                            <h6><i class="fas fa-brain"></i> Analyse IA</h6>
                            <p>${data.analysis || 'Aucune analyse disponible'}</p>
                        </div>
                        
                        <div class="text-muted">
                            <small>Analyse générée le ${new Date().toLocaleString('fr-FR')}</small>
                        </div>
                    `;
                    result.style.display = 'block';
                } else {
                    content.innerHTML = `<div class="alert alert-danger">Erreur: ${data.error}</div>`;
                    result.style.display = 'block';
                }
            } catch (error) {
                content.innerHTML = `<div class="alert alert-danger">Erreur: ${error.message}</div>`;
                result.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        });

        // Check ScrapingBee Status
        async function checkScrapingBeeStatus() {
            try {
                const response = await fetch('/api/scrapingbee/status');
                const data = await response.json();
                
                const statusIndicator = document.getElementById('scrapingbeeStatus');
                const statusText = document.getElementById('scrapingbeeStatusText');
                
                if (data.success && data.status.available) {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'ScrapingBee: En ligne';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'ScrapingBee: Hors ligne';
                }
            } catch (error) {
                const statusIndicator = document.getElementById('scrapingbeeStatus');
                const statusText = document.getElementById('scrapingbeeStatusText');
                statusIndicator.className = 'status-indicator status-warning';
                statusText.textContent = 'ScrapingBee: Erreur';
            }
        }

        // Check AI Status
        async function checkAIStatus() {
            try {
                const response = await fetch('/api/unified/status');
                const data = await response.json();
                
                const statusIndicator = document.getElementById('aiStatus');
                const statusText = document.getElementById('aiStatusText');
                
                if (data.status === "operational") {
                    statusIndicator.className = 'status-indicator status-online';
                    statusText.textContent = 'IA: En ligne';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'IA: Hors ligne';
                }
            } catch (error) {
                const statusIndicator = document.getElementById('aiStatus');
                const statusText = document.getElementById('aiStatusText');
                statusIndicator.className = 'status-indicator status-warning';
                statusText.textContent = 'IA: Erreur';
            }
        }

        // Load Market Updates
        async function loadMarketUpdates() {
            try {
                const response = await fetch('/api/market-updates');
                const data = await response.json();
                
                const updatesDiv = document.getElementById('marketUpdates');
                
                if (data.success && data.updates.length > 0) {
                    updatesDiv.innerHTML = data.updates.map(update => `
                        <div class="mb-2 p-2 border rounded">
                            <small class="text-muted">${new Date(update.created_at).toLocaleString('fr-FR')}</small>
                            <p class="mb-1">${update.content}</p>
                        </div>
                    `).join('');
                } else {
                    updatesDiv.innerHTML = '<p class="text-muted">Aucune mise à jour disponible</p>';
                }
            } catch (error) {
                document.getElementById('marketUpdates').innerHTML = '<p class="text-danger">Erreur de chargement</p>';
            }
        }

        // Check Service Status
        async function checkServiceStatus() {
            try {
                const response = await fetch('/api/endpoints');
                const data = await response.json();
                
                const statusDiv = document.getElementById('serviceStatus');
                
                if (data.success) {
                    statusDiv.innerHTML = `
                        <div class="mb-2">
                            <span class="status-indicator status-online"></span>
                            <span>API: En ligne</span>
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-online"></span>
                            <span>Base de données: En ligne</span>
                        </div>
                        <div class="mb-2">
                            <span class="status-indicator status-online"></span>
                            <span>Services: En ligne</span>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = '<p class="text-danger">Erreur de vérification</p>';
                }
            } catch (error) {
                document.getElementById('serviceStatus').innerHTML = '<p class="text-danger">Erreur de vérification</p>';
            }
        }

            // Initialize
            checkScrapingBeeStatus();
            checkAIStatus();
            loadMarketUpdates();
            checkServiceStatus();
            
            // Refresh buttons
            document.getElementById('refreshUpdates').addEventListener('click', loadMarketUpdates);
            document.getElementById('checkServices').addEventListener('click', checkServiceStatus);
        });
    </script>
</body>
</html> 