<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - BONVIN Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bonvin-blue': '#1e3a8a',
                        'bonvin-gold': '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glassmorphism-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-bonvin-blue via-blue-900 to-black min-h-screen text-white">
    <!-- Navigation -->
    <nav class="glassmorphism-dark p-4 mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="/static/BONVIN_120x120.png" alt="BONVIN" class="w-12 h-12">
                <h1 class="text-2xl font-bold text-bonvin-gold">BONVIN Collection</h1>
            </div>
            
            <!-- Hamburger Menu -->
            <div class="relative">
                <button id="hamburger" class="text-white hover:text-bonvin-gold transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <!-- Menu Dropdown -->
                <div id="menu" class="absolute right-0 mt-2 w-64 glassmorphism-dark rounded-lg shadow-xl hidden z-50">
                    <div class="p-4 space-y-2">
                        <a href="/" class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10 rounded transition-colors">
                            üìä Dashboard
                        </a>
                        <a href="/analytics" class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10 rounded transition-colors">
                            üìà Analytics
                        </a>
                        <a href="/sold" class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10 rounded transition-colors">
                            ‚úÖ Vendu
                        </a>
                        <a href="/markets" class="block px-4 py-2 text-white hover:bg-white hover:bg-opacity-10 rounded transition-colors">
                            üì∞ Update March√©s
                        </a>


                        <a href="/settings" class="block px-4 py-2 text-bonvin-gold bg-white bg-opacity-10 rounded transition-colors">
                            ‚öôÔ∏è Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-bonvin-gold mb-2">‚öôÔ∏è Settings</h2>
            <p class="text-gray-300">Configuration et statut du syst√®me</p>
        </div>

        <!-- Settings Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Market Updates Section -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üì∞ Market Updates</h3>
                
                <!-- Scheduler Status -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Scheduler Status</h4>
                    <div id="scheduler-status" class="bg-black bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Chargement...</span>
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-bonvin-gold"></div>
                        </div>
                    </div>
                </div>

                <!-- Manual Trigger -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">D√©clenchement Manuel</h4>
                    <div class="space-y-3">
                        <button id="trigger-market-update" class="w-full bg-bonvin-gold hover:bg-yellow-600 text-black font-semibold py-3 px-4 rounded-lg transition-colors">
                            üöÄ G√©n√©rer Update March√©s (Web Scraping)
                        </button>
                        <button id="trigger-global-update" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üåê G√©n√©rer GLOBAL MARKET UPDATE
                        </button>
                        <button id="trigger-csuite-update" class="w-full bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üè¢ G√©n√©rer C‚ÄëSuite Global Market Update
                        </button>
                        <button id="trigger-collection-news" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üì∞ G√©n√©rer Bonvin Collection News
                        </button>
                        <button id="trigger-swiss-update" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üá®üá≠ G√©n√©rer Update March√©s Suisse
                        </button>
                    </div>
                    
                    <div id="trigger-status" class="mt-3 text-sm text-gray-300"></div>
                    <div id="trigger-status-global" class="mt-2 text-sm text-gray-300"></div>
                    <div id="trigger-status-csuite" class="mt-2 text-sm text-gray-300"></div>
                    <div id="trigger-status-collection" class="mt-2 text-sm text-gray-300"></div>
                    <div id="trigger-status-swiss" class="mt-2 text-sm text-gray-300"></div>
                </div>

                <!-- Recent Updates -->
                <div>
                    <h4 class="text-lg font-medium mb-3">Derniers Updates</h4>
                    <div id="recent-updates" class="bg-black bg-opacity-30 rounded-lg p-4 max-h-64 overflow-y-auto">
                        <div class="text-gray-300">Chargement...</div>
                    </div>
                </div>
            </div>

            <!-- Stock Prices Section -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üìä Stock Prices</h3>
                
                <!-- Yahoo Finance Status -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Yahoo Finance Status</h4>
                    <div id="yahoo-status" class="bg-black bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Chargement...</span>
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-bonvin-gold"></div>
                        </div>
                    </div>
                </div>

                <!-- Cache Status -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Cache Status</h4>
                    <div id="cache-status" class="bg-black bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Chargement...</span>
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-bonvin-gold"></div>
                        </div>
                    </div>
                </div>

                <!-- Manual Update -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Mise √† Jour Manuelle</h4>
                    <div class="space-y-3">
                        <button id="update-all-stocks" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üîÑ Mettre √† Jour Tous les Prix
                        </button>
                        <div class="text-xs text-gray-400 text-center">
                            Mise √† jour optimis√©e avec les 10 requ√™tes quotidiennes disponibles
                        </div>
                    </div>
                    <div id="update-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Clear Cache -->
                <div>
                    <h4 class="text-lg font-medium mb-3">Gestion du Cache</h4>
                    <div class="space-y-3">
                        <button id="clear-cache" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üóëÔ∏è Vider le Cache
                        </button>
                        <button id="reset-requests" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üîÑ R√©initialiser Compteur Requ√™tes
                        </button>
                        <div class="text-xs text-gray-400 text-center">
                            En cas d'erreur 429 (Too Many Requests)
                        </div>
                    </div>
                    <div id="clear-status" class="mt-3 text-sm text-gray-300"></div>
                    <div id="reset-status" class="mt-3 text-sm text-gray-300"></div>
                </div>
            </div>

            <!-- Email Configuration -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üìß Email Configuration</h3>
                
                <!-- Email Status -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Configuration Email</h4>
                    <div id="email-config" class="bg-black bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Chargement...</span>
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-bonvin-gold"></div>
                        </div>
                    </div>
                </div>

                <!-- Test Email -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Test Email</h4>
                    <button id="test-email" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üì§ Envoyer Email de Test
                    </button>
                    <div id="test-email-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Market Report Email -->
                <div>
                    <h4 class="text-lg font-medium mb-3">üì∞ Rapport de March√©</h4>
                    <div class="space-y-3">
                        <button id="send-market-report" class="w-full bg-bonvin-gold hover:bg-yellow-600 text-black font-semibold py-3 px-4 rounded-lg transition-colors">
                            üìß Envoyer Rapport de March√©
                        </button>
                        <div class="text-xs text-gray-400 text-center">
                            Envoie le dernier rapport de march√© aux destinataires configur√©s
                        </div>
                    </div>
                    <div id="market-report-status" class="mt-3 text-sm text-gray-300"></div>
                </div>
            </div>

            <!-- System Status -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üîß System Status</h3>
                
                <!-- API Endpoints -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">API Endpoints</h4>
                    <div id="api-endpoints" class="bg-black bg-opacity-30 rounded-lg p-4 max-h-48 overflow-y-auto">
                        <div class="text-gray-300">Chargement...</div>
                    </div>
                </div>

                <!-- System Health -->
                <div>
                    <h4 class="text-lg font-medium mb-3">System Health</h4>
                    <div id="system-health" class="bg-black bg-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300">Chargement...</span>
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-bonvin-gold"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rapports PDF Manuels -->
            <div class="glassmorphism rounded-xl p-6 lg:col-span-2">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/10 border border-red-400/30 text-red-300">
                           <i class="fas fa-file-pdf"></i>
                        </div>
                        <div>
                           <h3 class="text-xl font-semibold text-bonvin-gold">Rapports PDF Manuels</h3>
                           <p class="text-sm text-gray-400">G√©rez les rapports de march√© PDF.</p>
                        </div>
                    </div>
                    <button id="refresh-pdfs" class="w-full sm:w-auto px-4 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Actualiser
                    </button>
                </div>

                <!-- Formulaire d'upload -->
                <div class="glassmorphism-dark p-4 rounded-xl mb-6">
                     <form id="market-pdf-upload-form" class="flex flex-col sm:flex-row items-center gap-4">
                        <input id="market-pdf-file" type="file" accept="application/pdf" required class="flex-grow w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-bonvin-gold/20 file:text-bonvin-gold hover:file:bg-bonvin-gold/30 text-gray-300"/>
                        <button type="submit" class="w-full sm:w-auto glowing-element px-5 py-3 rounded-xl bg-bonvin-gold/80 hover:bg-bonvin-gold text-black font-semibold transition">
                            <i class="fas fa-upload mr-2"></i> D√©poser
                        </button>
                    </form>
                    <div id="market-pdf-upload-status" class="mt-3 text-sm text-center"></div>
                </div>

                <!-- Galerie de PDFs -->
                <div id="market-pdf-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Les PDFs seront inject√©s ici par JS -->
                </div>
            </div>

            <!-- PDF Generation -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üìÑ PDF Generation</h3>
                
                <!-- Generate PDF -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">G√©n√©rer PDF</h4>
                    <button onclick="generatePDF()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üìÑ G√©n√©rer PDF de la Collection
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        G√©n√®re un rapport PDF complet de la collection
                    </div>
                    <div id="pdf-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Bank PDF Reports -->
                <div class="glassmorphism rounded-xl p-6 mt-6">
                    <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üè¶ Rapport Bancaire (PDF)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="window.open('/api/reports/all-asset-classes', '_blank')" class="w-full bg-bonvin-gold hover:bg-yellow-600 text-black font-semibold py-3 px-4 rounded-lg transition-colors">
                            üìÑ Tout le portefeuille (toutes classes)
                        </button>
                        <button onclick="window.open('/api/reports/asset-class/Actions cot√©es', '_blank')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üìà Actions cot√©es
                        </button>
                        <button onclick="window.open('/api/reports/bank/full?engine=puppeteer', '_blank')" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                            üè¶ Rapport Bancaire Exhaustif (A4)
                        </button>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        Astuce: ouvrez dans un nouvel onglet pour t√©l√©charger le PDF. Ajoutez d'autres classes si besoin.
                    </div>
                </div>
            </div>

            <!-- Push & Sync -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üöÄ Push & Sync</h3>
                
                <!-- Push All Updates -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Push Complet</h4>
                    <button id="push-all-updates" class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold py-4 px-4 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                        üöÄ Push Toutes les Mises √† Jour
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Synchronise tous les prix, donn√©es de march√© et notifications
                    </div>
                    <div id="push-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Quick Sync -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Sync Rapide</h4>
                    <button id="quick-sync" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        ‚ö° Sync Rapide
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Mise √† jour rapide des prix d'actions uniquement
                    </div>
                    <div id="quick-sync-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Push Notifications -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Push Notifications</h4>
                    <button id="push-notifications" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üì± Envoyer Notifications
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Envoie des notifications push pour les mises √† jour importantes
                    </div>
                    <div id="push-notifications-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Force Cache Refresh -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Force Cache Refresh</h4>
                    <button id="force-cache-refresh" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üîÑ Force Cache Refresh
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Force le rafra√Æchissement complet du cache syst√®me
                    </div>
                    <div id="force-cache-refresh-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Push to Database -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Push to Database</h4>
                    <button id="push-to-database" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üíæ Push to Database
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Synchronise toutes les modifications locales vers la base de donn√©es
                    </div>
                    <div id="push-to-database-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Push All Data -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Push All Data</h4>
                    <button id="push-all-data" class="w-full bg-gradient-to-r from-pink-600 to-red-600 hover:from-pink-700 hover:to-red-700 text-white font-semibold py-4 px-4 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                        üåü Push Toutes les Donn√©es
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Synchronisation compl√®te: prix, march√©s, analytics, cache et base de donn√©es
                    </div>
                    <div id="push-all-data-status" class="mt-3 text-sm text-gray-300"></div>
                </div>
            </div>

            <!-- Data Management -->
            <div class="glassmorphism rounded-xl p-6">
                <h3 class="text-xl font-semibold text-bonvin-gold mb-4">üìä Data Management</h3>
                
                <!-- CSV Import -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Import CSV</h4>
                    <button onclick="openImportModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üì• Importer CSV
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Importer de nouveaux √©l√©ments depuis un fichier CSV
                    </div>
                    <div id="import-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- CSV Rollback -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Rollback CSV</h4>
                    <button onclick="openRollbackModal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        ‚Ü©Ô∏è Rollback CSV
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Annuler le dernier import CSV
                    </div>
                    <div id="rollback-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Stock Price Update -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Mise √† Jour Prix Actions</h4>
                    <button onclick="forceUpdateStockPrices()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üìà Mettre √† Jour les Prix d'Actions
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Force la mise √† jour des prix d'actions depuis Yahoo Finance
                    </div>
                    <div id="stock-update-status" class="mt-3 text-sm text-gray-300"></div>
                </div>

                <!-- Category Fix -->
                <div>
                    <h4 class="text-lg font-medium mb-3">Correction Cat√©gories</h4>
                    <button onclick="fixVehicleCategories()" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                        üîß Corriger Cat√©gories 'V√©hicules' ‚Üí 'Voitures'
                    </button>
                    <div class="text-xs text-gray-400 mt-2 text-center">
                        Corrige les cat√©gories de v√©hicules dans la base de donn√©es
                    </div>
                    <div id="category-fix-status" class="mt-3 text-sm text-gray-300"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Hamburger Menu
        document.getElementById('hamburger').addEventListener('click', function() {
            document.getElementById('menu').classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('menu');
            const hamburger = document.getElementById('hamburger');
            if (!menu.contains(event.target) && !hamburger.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Load all status data
        async function loadAllStatus() {
            await Promise.all([
                loadSchedulerStatus(),
                loadRecentUpdates(),
                loadYahooStatus(),
                loadCacheStatus(),
                loadEmailConfig(),
                loadApiEndpoints(),
                loadSystemHealth(),
                loadMarketPdfs()
            ]);
        }

        async function loadMarketPdfs() {
            const container = document.getElementById('market-pdf-gallery');
            if (!container) return;
             try {
                container.innerHTML = '<p class="text-gray-400 col-span-full text-center">Chargement des rapports...</p>';
                const resp = await fetch('/api/market-pdfs');
                const data = await resp.json();
                if (!resp.ok || !data.success) throw new Error(data.error || 'Erreur de chargement');

                if (!data.files || data.files.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 col-span-full text-center">Aucun rapport PDF d√©pos√© pour le moment.</p>';
                    return;
                }
                
                // Trier les fichiers par date de modification, du plus r√©cent au plus ancien
                data.files.sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at));

                container.innerHTML = data.files.map(f => `
                    <article class="glassmorphism-dark p-4 rounded-2xl flex flex-col gap-3 transition-all hover:ring-2 ring-bonvin-gold/50">
                        <header class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/10 border border-red-400/30 text-red-300 shrink-0">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="font-semibold text-bonvin-gold truncate" title="${f.name}">${f.name}</h4>
                                <p class="text-gray-400 text-xs">${new Date(f.modified_at).toLocaleString('fr-FR')}</p>
                            </div>
                        </header>
                         <div class="rounded-xl overflow-hidden border border-white/10 bg-black/30 aspect-video mt-2">
                           <iframe src="${f.url}#toolbar=0&navpanes=0&scrollbar=0" class="w-full h-full border-0"></iframe>
                        </div>
                        <footer class="flex gap-2 justify-end mt-2">
                            <a href="${f.url}" target="_blank" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm transition-colors">Ouvrir</a>
                            <a href="${f.url}" download class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm transition-colors">T√©l√©charger</a>
                        </footer>
                    </article>
                `).join('');
            } catch (e) {
                const container = document.getElementById('market-pdf-gallery');
                if (container) container.innerHTML = `<p class="text-red-400 col-span-full text-center">‚ùå Erreur lors du chargement des PDFs: ${e.message}</p>`;
            }
        }

        // Scheduler Status
        async function loadSchedulerStatus() {
            try {
                const response = await fetch('/api/market-updates/scheduler-status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('scheduler-status');
                statusDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Status:</span>
                            <span class="${data.is_running ? 'text-green-400' : 'text-red-400'} font-semibold">
                                ${data.is_running ? '‚úÖ Actif' : '‚ùå Inactif'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Prochaine ex√©cution:</span>
                            <span class="text-white">${data.next_run || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Heure configur√©e:</span>
                            <span class="text-white">${data.scheduled_time}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('scheduler-status').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // Recent Updates
        async function loadRecentUpdates() {
            try {
                const response = await fetch('/api/market-updates');
                const data = await response.json();
                
                const updatesDiv = document.getElementById('recent-updates');
                if (data.updates && data.updates.length > 0) {
                    updatesDiv.innerHTML = data.updates.slice(0, 5).map(update => `
                        <div class="border-b border-gray-600 pb-2 mb-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="text-white font-medium">Briefing du ${update.date}</div>
                                    <div class="text-gray-400 text-sm">${update.time} (${update.trigger_type === 'manual' ? 'Manuel' : 'Auto'})</div>
                                    <div class="text-gray-500 text-xs mt-1 line-clamp-2">${update.content.substring(0, 100)}...</div>
                                </div>
                                <span class="text-xs ${update.trigger_type === 'manual' ? 'bg-yellow-600' : 'bg-blue-600'} px-2 py-1 rounded ml-2">
                                    ${update.trigger_type === 'manual' ? 'üîÑ' : '‚è∞'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    updatesDiv.innerHTML = '<div class="text-gray-400">Aucun update r√©cent</div>';
                }
            } catch (error) {
                document.getElementById('recent-updates').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // Yahoo Finance Status
        async function loadYahooStatus() {
            try {
                const response = await fetch('/api/yahoo-finance/status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('yahoo-status');
                statusDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Status:</span>
                            <span class="${data.available ? 'text-green-400' : 'text-red-400'} font-semibold">
                                ${data.available ? '‚úÖ Op√©rationnel' : '‚ùå Indisponible'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Test:</span>
                            <span class="text-white">${data.test_symbol || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Prix test:</span>
                            <span class="text-white">${data.test_price || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('yahoo-status').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // Cache Status
        async function loadCacheStatus() {
            try {
                const response = await fetch('/api/stock-price/cache/status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('cache-status');
                statusDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Taille cache:</span>
                            <span class="text-white">${data.cache_size} entr√©es</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Historique:</span>
                            <span class="text-white">${data.history_size} symboles</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Requ√™tes/jour:</span>
                            <span class="text-white">${data.daily_requests}/${data.max_daily_requests}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Peut requ√™ter:</span>
                            <span class="${data.can_make_request ? 'text-green-400' : 'text-red-400'} font-semibold">
                                ${data.can_make_request ? '‚úÖ Oui' : '‚ùå Non'}
                            </span>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('cache-status').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // Email Config
        async function loadEmailConfig() {
            try {
                const response = await fetch('/api/email-config');
                const data = await response.json();
                
                const configDiv = document.getElementById('email-config');
                configDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Host:</span>
                            <span class="text-white">${data.host || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Port:</span>
                            <span class="text-white">${data.port || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">User:</span>
                            <span class="text-white">${data.user ? '‚úÖ Configur√©' : '‚ùå Non configur√©'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Destinataires:</span>
                            <span class="text-white">${data.recipients_count || 0}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('email-config').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // API Endpoints
        async function loadApiEndpoints() {
            try {
                const response = await fetch('/api/endpoints');
                const data = await response.json();
                
                const endpointsDiv = document.getElementById('api-endpoints');
                endpointsDiv.innerHTML = `
                    <div class="space-y-1 text-sm">
                        ${data.endpoints.map(endpoint => `
                            <div class="flex justify-between">
                                <span class="text-gray-300">${endpoint.method}</span>
                                <span class="text-white">${endpoint.route}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('api-endpoints').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // System Health
        async function loadSystemHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const healthDiv = document.getElementById('system-health');
                healthDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">Status:</span>
                            <span class="text-green-400 font-semibold">‚úÖ Op√©rationnel</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Version:</span>
                            <span class="text-white">${data.version || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Timestamp:</span>
                            <span class="text-white">${new Date(data.timestamp).toLocaleString('fr-FR')}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('system-health').innerHTML = `
                    <div class="text-red-400">Erreur de chargement</div>
                `;
            }
        }

        // Manual Trigger Market Update
        document.getElementById('trigger-market-update').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('trigger-status');
            
            button.disabled = true;
            button.textContent = 'üîÑ G√©n√©ration en cours...';
            statusDiv.textContent = 'G√©n√©ration de l\'update en cours...';
            
            try {
                const response = await fetch('/api/background-worker/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: "Analyse march√© globale aujourd'hui avec focus IA",
                        force: true
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.status === 'already_in_progress') {
                        statusDiv.innerHTML = '<span class="text-yellow-400">‚ÑπÔ∏è Une analyse est d√©j√† en cours. Actualisation automatique de l\'√©tat...</span>';
                    } else {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Update g√©n√©r√© avec succ√®s!</span>';
                    }
                    await loadRecentUpdates(); // Refresh the list
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ G√©n√©rer Update March√©s (Web Scraping)';
            }
        });

        // Manual Trigger GLOBAL MARKET UPDATE
        document.getElementById('trigger-global-update').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('trigger-status-global');
            button.disabled = true;
            button.textContent = 'üîÑ G√©n√©ration GLOBAL en cours...';
            statusDiv.textContent = 'Planification du GLOBAL MARKET UPDATE...';
            try {
                const response = await fetch('/api/market-analysis/global/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force: true })
                });
                const data = await response.json();
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ GLOBAL MARKET UPDATE planifi√©</span>';
                    await loadRecentUpdates();
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error || '√âchec serveur'}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üåê G√©n√©rer GLOBAL MARKET UPDATE';
            }
        });

        // Manual Trigger C‚ÄëSuite Global Market Update
        document.getElementById('trigger-csuite-update').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('trigger-status-csuite');
            button.disabled = true;
            button.textContent = 'üîÑ G√©n√©ration C‚ÄëSuite en cours...';
            statusDiv.textContent = 'Planification du C‚ÄëSuite Global Market Update...';
            try {
                const response = await fetch('/api/market-analysis/csuite/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ force: true })
                });
                const data = await response.json();
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ C‚ÄëSuite Global Market Update planifi√©</span>';
                    await loadRecentUpdates();
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error || '√âchec serveur'}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üè¢ G√©n√©rer C‚ÄëSuite Global Market Update';
            }
        });

        const collectionButton = document.getElementById('trigger-collection-news');
        const collectionStatus = document.getElementById('trigger-status-collection');
        if (collectionButton && collectionStatus) {
            collectionButton.addEventListener('click', async function() {
                const button = this;
                button.disabled = true;
                button.textContent = 'üîÑ G√©n√©ration Bonvin Collection News en cours...';
                collectionStatus.textContent = 'Planification du Bonvin Collection News...';
                try {
                    const response = await fetch('/api/market-analysis/collection-news/trigger', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force: true })
                    });
                    const data = await response.json();
                    if (data.success) {
                        collectionStatus.innerHTML = '<span class="text-green-400">‚úÖ Bonvin Collection News planifi√©</span>';
                        await loadRecentUpdates();
                    } else {
                        collectionStatus.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error || '√âchec serveur'}</span>`;
                    }
                } catch (error) {
                    collectionStatus.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
                } finally {
                    button.disabled = false;
                    button.textContent = 'üì∞ G√©n√©rer Bonvin Collection News';
                }
            });
        }

        // Manual Trigger Swiss Market Update
        document.getElementById('trigger-swiss-update').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('trigger-status-swiss');
            
            button.disabled = true;
            button.textContent = 'üîÑ G√©n√©ration Suisse en cours...';
            statusDiv.textContent = 'G√©n√©ration du rapport March√© Suisse en cours...';
            
            try {
                const response = await fetch('/api/swiss-update/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                
                if (data.success) {
                    const preview = (data.preview || '').toString().slice(0, 180);
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Rapport Suisse g√©n√©r√© et trait√©.</span>' + (preview ? `<div class="text-gray-400 text-xs mt-1">Aper√ßu: ${preview}‚Ä¶</div>` : '');
                    await loadRecentUpdates();
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error || '√âchec serveur'}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üá®üá≠ G√©n√©rer Update March√©s Suisse';
            }
        });

        // NewsAPI flow removed

        // Update All Stocks
        document.getElementById('update-all-stocks').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('update-status');
            
            button.disabled = true;
            button.textContent = 'üîÑ Mise √† jour en cours...';
            statusDiv.textContent = 'Mise √† jour optimis√©e des prix en cours...';
            
            try {
                const response = await fetch('/api/stock-price/update-all', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    let statusHTML = `<span class="text-green-400">‚úÖ Mise √† jour termin√©e</span><br>`;
                    statusHTML += `<span class="text-gray-300 text-xs">‚Ä¢ ${data.updated_count} symboles trait√©s</span><br>`;
                    
                    if (data.requests_used !== undefined) {
                        statusHTML += `<span class="text-blue-400 text-xs">‚Ä¢ ${data.requests_used} requ√™tes utilis√©es</span><br>`;
                    }
                    
                    if (data.cache_used !== undefined) {
                        statusHTML += `<span class="text-amber-400 text-xs">‚Ä¢ ${data.cache_used} depuis le cache</span><br>`;
                    }
                    
                    if (data.skipped_count !== undefined && data.skipped_count > 0) {
                        statusHTML += `<span class="text-orange-400 text-xs">‚Ä¢ ${data.skipped_count} ignor√©s (limite atteinte)</span>`;
                    }
                    
                    statusDiv.innerHTML = statusHTML;
                    await loadCacheStatus(); // Refresh cache status
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ Mettre √† Jour Tous les Prix';
            }
        });

        // Clear Cache
        document.getElementById('clear-cache').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('clear-status');
            
            if (!confirm('√ätes-vous s√ªr de vouloir vider le cache ?')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = 'üóëÔ∏è Vidage en cours...';
            statusDiv.textContent = 'Vidage du cache en cours...';
            
            try {
                const response = await fetch('/api/stock-price/cache/clear', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Cache vid√© avec succ√®s</span>';
                    await loadCacheStatus(); // Refresh cache status
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üóëÔ∏è Vider le Cache';
            }
        });

        // Reset Requests Counter
        document.getElementById('reset-requests').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('reset-status');
            
            if (!confirm('√ätes-vous s√ªr de vouloir r√©initialiser le compteur de requ√™tes ? Cela permettra de faire de nouvelles requ√™tes API.')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = 'üîÑ R√©initialisation en cours...';
            statusDiv.textContent = 'R√©initialisation du compteur en cours...';
            
            try {
                const response = await fetch('/api/stock-price/reset-requests', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Compteur r√©initialis√© avec succ√®s</span>';
                    await loadCacheStatus(); // Refresh cache status
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.message}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üîÑ R√©initialiser Compteur Requ√™tes';
            }
        });

        // Test Email
        document.getElementById('test-email').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('test-email-status');
            
            button.disabled = true;
            button.textContent = 'üì§ Envoi en cours...';
            statusDiv.textContent = 'Envoi de l\'email de test...';
            
            try {
                const response = await fetch('/api/test-email', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Email de test envoy√©!</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üì§ Envoyer Email de Test';
            }
        });

        // Send Market Report Email
        document.getElementById('send-market-report').addEventListener('click', async function() {
            const button = this;
            const statusDiv = document.getElementById('market-report-status');
            
            if (!confirm('√ätes-vous s√ªr de vouloir envoyer le rapport de march√© par email aux destinataires configur√©s ?')) {
                return;
            }
            
            button.disabled = true;
            button.textContent = 'üìß Envoi en cours...';
            statusDiv.textContent = 'G√©n√©ration et envoi du rapport de march√©...';
            
            try {
                const response = await fetch('/api/send-market-report-email', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Rapport de march√© envoy√© avec succ√®s!</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            } finally {
                button.disabled = false;
                button.textContent = 'üìß Envoyer Rapport de March√©';
            }
        });

        // Auto-refresh every 30 seconds
        setInterval(loadAllStatus, 30000);

        // Initial load
        loadAllStatus();

        // PDF Generation
        async function generatePDF() {
            const statusDiv = document.getElementById('pdf-status');
            statusDiv.textContent = 'G√©n√©ration du PDF en cours...';
            
            try {
                const response = await fetch('/generate-pdf', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'collection-bonvin.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ PDF g√©n√©r√© et t√©l√©charg√© avec succ√®s!</span>';
                } else {
                    statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors de la g√©n√©ration du PDF</span>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            }
        }

        // CSV Import Modal
        function openImportModal() {
            const statusDiv = document.getElementById('import-status');
            statusDiv.innerHTML = '<span class="text-blue-400">‚ÑπÔ∏è Redirection vers la page principale pour l\'import CSV...</span>';
            
            // Redirect to main page where import modal is available
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        }

        // CSV Rollback Modal
        function openRollbackModal() {
            const statusDiv = document.getElementById('rollback-status');
            statusDiv.innerHTML = '<span class="text-blue-400">‚ÑπÔ∏è Redirection vers la page principale pour le rollback CSV...</span>';
            
            // Redirect to main page where rollback modal is available
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        }

        // Force Update Stock Prices
        async function forceUpdateStockPrices() {
            const statusDiv = document.getElementById('stock-update-status');
            statusDiv.textContent = 'Mise √† jour des prix d\'actions en cours...';
            
            try {
                const response = await fetch('/force-update-stock-prices', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Prix d\'actions mis √† jour avec succ√®s!</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            }
        }

        // Fix Vehicle Categories
        async function fixVehicleCategories() {
            const statusDiv = document.getElementById('category-fix-status');
            
            if (!confirm('√ätes-vous s√ªr de vouloir corriger les cat√©gories de v√©hicules ? Cette action modifiera la base de donn√©es.')) {
                return;
            }
            
            statusDiv.textContent = 'Correction des cat√©gories en cours...';
            
            try {
                const response = await fetch('/fix-vehicle-categories', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Cat√©gories corrig√©es avec succ√®s!</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur de connexion</span>';
            }
        }

        // Push All Updates
        async function pushAllUpdates() {
            const button = document.getElementById('push-all-updates');
            const statusDiv = document.getElementById('push-status');
            
            button.disabled = true;
            button.innerHTML = 'üîÑ Push en cours...';
            statusDiv.innerHTML = '<span class="text-blue-400">üöÄ D√©but du push complet...</span>';
            
            try {
                // Step 1: Update stock prices
                statusDiv.innerHTML = '<span class="text-blue-400">üìà Mise √† jour des prix d\'actions...</span>';
                const stockResponse = await fetch('/api/stock-price/update-all', {
                    method: 'POST'
                });
                const stockData = await stockResponse.json();
                
                // Step 2: Trigger market update
                statusDiv.innerHTML = '<span class="text-blue-400">üìä G√©n√©ration du rapport de march√©...</span>';
                const marketResponse = await fetch('/api/market-updates/trigger', {
                    method: 'POST'
                });
                const marketData = await marketResponse.json();
                
                // Step 3: Send market report email
                statusDiv.innerHTML = '<span class="text-blue-400">üìß Envoi du rapport de march√©...</span>';
                const emailResponse = await fetch('/api/send-market-report', {
                    method: 'POST'
                });
                const emailData = await emailResponse.json();
                
                // Step 4: Refresh cache
                statusDiv.innerHTML = '<span class="text-blue-400">üîÑ Actualisation du cache...</span>';
                await loadCacheStatus();
                
                // Success message
                let successMessage = '<span class="text-green-400">‚úÖ Push complet termin√©!</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Prix d\'actions mis √† jour</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Rapport de march√© g√©n√©r√©</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Email envoy√©</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Cache actualis√©</span>';
                
                statusDiv.innerHTML = successMessage;
                
            } catch (error) {
                console.error('Erreur push complet:', error);
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors du push complet</span>';
            } finally {
                button.disabled = false;
                button.innerHTML = 'üöÄ Push Toutes les Mises √† Jour';
            }
        }

        // Quick Sync
        async function quickSync() {
            const button = document.getElementById('quick-sync');
            const statusDiv = document.getElementById('quick-sync-status');
            
            button.disabled = true;
            button.innerHTML = '‚ö° Sync en cours...';
            statusDiv.innerHTML = '<span class="text-blue-400">‚ö° Sync rapide en cours...</span>';
            
            try {
                const response = await fetch('/api/stock-price/update-all', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Sync rapide termin√©!</span><br><span class="text-gray-300 text-xs">‚Ä¢ Prix d\'actions mis √† jour</span>';
                } else {
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error}</span>`;
                }
            } catch (error) {
                console.error('Erreur sync rapide:', error);
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors du sync rapide</span>';
            } finally {
                button.disabled = false;
                button.innerHTML = '‚ö° Sync Rapide';
            }
        }

        // Push Notifications
        async function pushNotifications() {
            const button = document.getElementById('push-notifications');
            const statusDiv = document.getElementById('push-notifications-status');
            
            button.disabled = true;
            button.innerHTML = 'üì± Envoi en cours...';
            statusDiv.innerHTML = '<span class="text-blue-400">üì± Envoi des notifications push...</span>';
            
            try {
                // Send test notification
                const response = await fetch('/api/push-notifications', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'system_update',
                        message: 'Mise √† jour syst√®me effectu√©e',
                        priority: 'normal'
                    })
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Notifications envoy√©es avec succ√®s!</span>';
                } else {
                    const data = await response.json();
                    statusDiv.innerHTML = `<span class="text-red-400">‚ùå Erreur: ${data.error || 'Erreur serveur'}</span>`;
                }
            } catch (error) {
                console.error('Erreur notifications push:', error);
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors de l\'envoi des notifications</span>';
            } finally {
                button.disabled = false;
                button.innerHTML = 'üì± Envoyer Notifications';
            }
        }

        // Force Cache Refresh
        async function forceCacheRefresh() {
            const button = document.getElementById('force-cache-refresh');
            const statusDiv = document.getElementById('force-cache-refresh-status');
            
            button.disabled = true;
            button.innerHTML = 'üîÑ Refresh en cours...';
            statusDiv.innerHTML = '<span class="text-blue-400">üîÑ Force refresh du cache en cours...</span>';
            
            try {
                // Clear all caches
                const clearResponse = await fetch('/api/stock-price/cache/clear', {
                    method: 'POST'
                });
                
                // Reset request counter
                const resetResponse = await fetch('/api/stock-price/reset-requests', {
                    method: 'POST'
                });
                
                // Refresh cache status
                await loadCacheStatus();
                
                statusDiv.innerHTML = '<span class="text-green-400">‚úÖ Cache refresh forc√© avec succ√®s!</span><br><span class="text-gray-300 text-xs">‚Ä¢ Cache vid√©</span><br><span class="text-gray-300 text-xs">‚Ä¢ Compteur r√©initialis√©</span>';
                
            } catch (error) {
                console.error('Erreur force cache refresh:', error);
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors du force refresh</span>';
            } finally {
                button.disabled = false;
                button.innerHTML = 'üîÑ Force Cache Refresh';
            }
        }

        // Push to Database
        async function pushToDatabase() {
            const button = document.getElementById('push-to-database');
            const statusDiv = document.getElementById('push-to-database-status');
            
            button.disabled = true;
            button.innerHTML = 'üíæ Push en cours...';
            statusDiv.innerHTML = '<span class="text-blue-400">üíæ Synchronisation vers la base de donn√©es...</span>';
            
            try {
                // Step 1: Sync all items
                statusDiv.innerHTML = '<span class="text-blue-400">üìä Synchronisation des √©l√©ments...</span>';
                const itemsResponse = await fetch('/api/items/sync-all', {
                    method: 'POST'
                });
                
                // Step 2: Sync analytics
                statusDiv.innerHTML = '<span class="text-blue-400">üìà Synchronisation des analytics...</span>';
                const analyticsResponse = await fetch('/api/analytics/sync', {
                    method: 'POST'
                });
                
                // Step 3: Sync cache
                statusDiv.innerHTML = '<span class="text-blue-400">üîÑ Synchronisation du cache...</span>';
                const cacheResponse = await fetch('/api/cache/sync', {
                    method: 'POST'
                });
                
                // Step 4: Refresh all status
                statusDiv.innerHTML = '<span class="text-blue-400">üîÑ Actualisation des statuts...</span>';
                await loadAllStatus();
                
                // Success message
                let successMessage = '<span class="text-green-400">‚úÖ Push to Database termin√©!</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ √âl√©ments synchronis√©s</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Analytics synchronis√©s</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Cache synchronis√©</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Statuts actualis√©s</span>';
                
                statusDiv.innerHTML = successMessage;
                
            } catch (error) {
                console.error('Erreur push to database:', error);
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors du push vers la base de donn√©es</span>';
            } finally {
                button.disabled = false;
                button.innerHTML = 'üíæ Push to Database';
            }
        }

        // Push All Data
        async function pushAllData() {
            const button = document.getElementById('push-all-data');
            const statusDiv = document.getElementById('push-all-data-status');
            
            button.disabled = true;
            button.innerHTML = 'üåü Push en cours...';
            statusDiv.innerHTML = '<span class="text-blue-400">üåü Synchronisation compl√®te en cours...</span>';
            
            try {
                // Step 1: Update all stock prices
                statusDiv.innerHTML = '<span class="text-blue-400">üìà Mise √† jour des prix d\'actions...</span>';
                const stockResponse = await fetch('/api/stock-price/update-all', {
                    method: 'POST'
                });
                
                // Step 2: Trigger market updates
                statusDiv.innerHTML = '<span class="text-blue-400">üìä Mise √† jour des march√©s...</span>';
                const marketResponse = await fetch('/api/market-updates/trigger', {
                    method: 'POST'
                });
                
                // Step 3: Send market report
                statusDiv.innerHTML = '<span class="text-blue-400">üì∞ Envoi du rapport de march√©...</span>';
                const reportResponse = await fetch('/api/send-market-report', {
                    method: 'POST'
                });
                
                // Step 4: Push notifications
                statusDiv.innerHTML = '<span class="text-blue-400">üì± Envoi des notifications...</span>';
                const notificationResponse = await fetch('/api/push-notifications', {
                    method: 'POST'
                });
                
                // Step 5: Sync all items
                statusDiv.innerHTML = '<span class="text-blue-400">üìä Synchronisation des √©l√©ments...</span>';
                const itemsResponse = await fetch('/api/items/sync-all', {
                    method: 'POST'
                });
                
                // Step 6: Sync analytics
                statusDiv.innerHTML = '<span class="text-blue-400">üìà Synchronisation des analytics...</span>';
                const analyticsResponse = await fetch('/api/analytics/sync', {
                    method: 'POST'
                });
                
                // Step 7: Sync cache
                statusDiv.innerHTML = '<span class="text-blue-400">üîÑ Synchronisation du cache...</span>';
                const cacheResponse = await fetch('/api/cache/sync', {
                    method: 'POST'
                });
                
                // Step 8: Refresh all status
                statusDiv.innerHTML = '<span class="text-blue-400">üîÑ Actualisation des statuts...</span>';
                await loadAllStatus();
                
                // Success message
                let successMessage = '<span class="text-green-400">‚úÖ Push All Data termin√©!</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Prix d\'actions mis √† jour</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ March√©s synchronis√©s</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Rapport de march√© envoy√©</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Notifications push envoy√©es</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ √âl√©ments synchronis√©s</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Analytics synchronis√©s</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Cache synchronis√©</span><br>';
                successMessage += '<span class="text-gray-300 text-xs">‚Ä¢ Statuts actualis√©s</span>';
                
                statusDiv.innerHTML = successMessage;
                
            } catch (error) {
                console.error('Erreur push all data:', error);
                statusDiv.innerHTML = '<span class="text-red-400">‚ùå Erreur lors du push complet des donn√©es</span>';
            } finally {
                button.disabled = false;
                button.innerHTML = 'üåü Push Toutes les Donn√©es';
            }
        }

        // Add event listeners for push buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Upload PDF March√©
            const uploadForm = document.getElementById('market-pdf-upload-form');
            if (uploadForm) {
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fileInput = document.getElementById('market-pdf-file');
                    const statusDiv = document.getElementById('market-pdf-upload-status');
                    const uploadButton = uploadForm.querySelector('button[type="submit"]');

                    statusDiv.textContent = '';
                    if (!fileInput.files || fileInput.files.length === 0) {
                        statusDiv.innerHTML = `<span class="text-red-400">Veuillez s√©lectionner un fichier PDF.</span>`;
                        return;
                    }
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);

                    const originalButtonHtml = uploadButton.innerHTML;
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> D√©versement...';
                    statusDiv.innerHTML = '<span class="text-blue-400">D√©versement en cours...</span>';

                    try {
                        const resp = await fetch('/api/market-pdfs/upload', { method: 'POST', body: formData });
                        const data = await resp.json();
                        if (!resp.ok || !data.success) {
                            throw new Error(data.error || '√âchec du t√©l√©versement');
                        }
                        statusDiv.innerHTML = `<span class="text-green-400">‚úÖ Fichier d√©pos√©: ${data.name}</span>`;
                        fileInput.value = '';
                        await loadMarketPdfs();
                    } catch (err) {
                        statusDiv.innerHTML = `<span class="text-red-400">‚ùå ${err.message}</span>`;
                    } finally {
                        uploadButton.disabled = false;
                        uploadButton.innerHTML = originalButtonHtml;
                    }
                });
            }

            const refreshPdfsBtn = document.getElementById('refresh-pdfs');
            if(refreshPdfsBtn) {
                refreshPdfsBtn.addEventListener('click', loadMarketPdfs);
            }

            const pushButton = document.getElementById('push-all-updates');
            const quickSyncButton = document.getElementById('quick-sync');
            const pushNotificationsButton = document.getElementById('push-notifications');
            const forceCacheRefreshButton = document.getElementById('force-cache-refresh');
            const pushToDatabaseButton = document.getElementById('push-to-database');
            const pushAllDataButton = document.getElementById('push-all-data');
            
            if (pushButton) {
                pushButton.addEventListener('click', pushAllUpdates);
            }
            
            if (quickSyncButton) {
                quickSyncButton.addEventListener('click', quickSync);
            }
            
            if (pushNotificationsButton) {
                pushNotificationsButton.addEventListener('click', pushNotifications);
            }
            
            if (forceCacheRefreshButton) {
                forceCacheRefreshButton.addEventListener('click', forceCacheRefresh);
            }
            
            if (pushToDatabaseButton) {
                pushToDatabaseButton.addEventListener('click', pushToDatabase);
            }
            
            if (pushAllDataButton) {
                pushAllDataButton.addEventListener('click', pushAllData);
            }
        });
    </script>
</body>
</html> 